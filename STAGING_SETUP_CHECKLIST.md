# Staging Setup Checklist

## ‚úÖ Step 1: Staging Branch Created
- [x] Created `staging` branch
- [x] Pushed to GitHub

## üìã Step 2: Create Render Staging Service

### Go to Render Dashboard:
1. Visit: https://dashboard.render.com
2. Click **"New +"** ‚Üí **"Web Service"**
3. Connect your GitHub repository (if not already connected)
4. Select: `eazyapp-tech/onboard-hub`

### Configure Service:
- **Name**: `onboard-hub-backend-staging`
- **Region**: Same as production
- **Branch**: `staging` ‚ö†Ô∏è **IMPORTANT: Change from `main` to `staging`**
- **Root Directory**: `backend`
- **Runtime**: `Node`
- **Build Command**: `npm install`
- **Start Command**: `node server.js`
- **Plan**: Free (or same as production)

### Advanced Settings:
- **Auto-Deploy**: `Yes`
- **Health Check Path**: `/health`

Click **"Create Web Service"**

---

## üîê Step 3: Copy Environment Variables

### From Production Service:
1. Go to your production service: `onboard-hub-backend` (or similar)
2. Click **"Environment"** tab
3. Copy all environment variables

### To Staging Service:
1. Go to new staging service
2. Click **"Environment"** tab
3. Add each variable (copy-paste from production)

### Key Variables to Verify:
```
MONGO_URL=<your-mongo-url>
DB_NAME=onboard-hub (or onboard-hub-staging if using separate DB)
PORT=10000 (auto-assigned, but can set)
NODE_ENV=staging

GOOGLE_APPLICATION_CREDENTIALS=<your-credentials>
GSUITE_IMPERSONATE_USER=<your-user>
UNIVERSAL_SHEET_ID=1FfAG2BJc9aK8cmnxoc6O90ArNNJw9_FIlhgHVDY6SWA

CLERK_SECRET_KEY=<your-key>
```

### Optional: Add Staging-Specific Variable
```
ENVIRONMENT=staging
```

Click **"Save Changes"** (service will auto-redeploy)

---

## ‚è±Ô∏è Step 4: Wait for Deployment

1. Go to **"Logs"** tab
2. Watch the build process
3. Wait for status to show **"Live"** (green)
4. Note your staging URL: `https://onboard-hub-backend-staging.onrender.com`

### Test Health Endpoint:
Visit: `https://onboard-hub-backend-staging.onrender.com/health`

Should return: `{"ok":true,"env":"staging"}`

---

## üé® Step 5: Update Frontend Preview Environment

### In Vercel Dashboard:
1. Go to: https://vercel.com/dashboard
2. Select your frontend project
3. Go to **Settings** ‚Üí **Environment Variables**

### Update BACKEND_URL:
1. Find `BACKEND_URL` or `NEXT_PUBLIC_API_BASE_URL`
2. Click on it to edit
3. For **Preview** environment, set value to:
   ```
   https://onboard-hub-backend-staging.onrender.com
   ```
4. Keep **Production** environment as:
   ```
   https://onboard-hub.onrender.com
   ```
   (or your current production URL)

5. Click **"Save"**

### Alternative: If using config.ts
Update `frontend/src/lib/config.ts` to check environment:
```typescript
const API_BASE_URL = process.env.NODE_ENV === 'production' 
  ? 'https://onboard-hub.onrender.com'  // Production
  : process.env.VERCEL_ENV === 'preview'
  ? 'https://onboard-hub-backend-staging.onrender.com'  // Preview/Staging
  : 'http://localhost:4000';  // Local

export { API_BASE_URL };
```

---

## ‚úÖ Step 6: Test the Setup

### Test 1: Staging Backend Health
```bash
curl https://onboard-hub-backend-staging.onrender.com/health
```

### Test 2: Create Preview Deployment
```bash
# Create a test feature branch
git checkout -b test-preview
git push origin test-preview
```

### Test 3: Check Preview Frontend
- Go to Vercel dashboard
- Find the preview deployment
- Open the preview URL
- Check browser console for API calls
- Verify API calls go to staging backend

---

## üìù Your Staging URLs

- **Staging Backend**: `https://onboard-hub-backend-staging.onrender.com`
- **Production Backend**: `https://onboard-hub.onrender.com` (or your current URL)
- **Preview Frontend**: Auto-generated by Vercel (e.g., `https://onboard-hub-abc123.vercel.app`)

---

## üöÄ Workflow Going Forward

### To Deploy Changes to Staging:
```bash
git checkout staging
git merge feature/your-feature
git push origin staging
# Render auto-deploys staging backend
```

### To Deploy to Production:
```bash
git checkout main
git merge staging  # or merge feature directly
git push origin main
# Render auto-deploys production backend
```

---

## ‚ö†Ô∏è Important Notes

1. **CORS**: Already configured to allow `.vercel.app` domains ‚úÖ
2. **Free Tier**: Services sleep after 15 min inactivity
3. **Cold Start**: First request after sleep takes ~30 seconds
4. **Database**: Using same MongoDB as production (or create separate one)
5. **Sheet**: Using same Google Sheet (or create test sheet)

---

## üêõ Troubleshooting

### Staging service won't start?
- Check build logs in Render
- Verify environment variables are set
- Check `package.json` has correct scripts

### Preview frontend can't connect?
- Verify `BACKEND_URL` is set in Vercel preview environment
- Check staging backend is "Live" (not sleeping)
- Test health endpoint directly

### Environment variables not working?
- Verify saved correctly (check for typos)
- Redeploy after changing env vars
- Check variable names match exactly

---

## ‚úÖ Completion Checklist

- [ ] Staging branch created and pushed
- [ ] Render staging service created
- [ ] Environment variables copied
- [ ] Staging service deployed and "Live"
- [ ] Health endpoint working
- [ ] Frontend preview environment updated
- [ ] Test preview deployment created
- [ ] Preview frontend connects to staging backend

---

**Once all checked, your staging environment is ready! üéâ**

